<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KTY HALAAL BILTONG</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = { corePlugins: { preflight: false } }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8VkN2_icMo9LEM1TbPjDf_kckmSI41z0",
            authDomain: "biltong-fd731.firebaseapp.com",
            projectId: "biltong-fd731",
            storageBucket: "biltong-fd731.firebasestorage.app",
            messagingSenderId: "922275664562",
            appId: "1:922275664562:web:c07db5cd9d5a90b936afab",
            measurementId: "G-ZMXEPCM0VH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const PRICE_PER_PACK = 35;
        const COST_PER_PACK = 16.25; 

        let allOrders = [];
        let groupedCustomers = {};

        window.saveOrder = async () => {
            const customer = document.getElementById('customer').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const flavor = document.getElementById('flavor').value;
            const qty = parseInt(document.getElementById('qty').value);
            const isPaid = document.getElementById('isPaid').checked;
            
            if(!customer || isNaN(qty) || qty <= 0) {
                showToast("Please fill in all fields correctly!", "error");
                return;
            }

            try {
                await addDoc(collection(db, "orders"), {
                    customer, phone, flavor, qty,
                    totalSales: qty * PRICE_PER_PACK,
                    totalProfit: qty * (PRICE_PER_PACK - COST_PER_PACK),
                    paid: isPaid,
                    timestamp: new Date()
                });
                showToast("Order logged successfully!", "success");
                document.getElementById('customer').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('qty').value = '';
                document.getElementById('isPaid').checked = false;
                await loadData();
            } catch (e) { 
                showToast("Error: " + e.message, "error"); 
            }
        };

        window.markAsPaid = async (orderId) => {
            const btn = event.target;
            btn.disabled = true;
            btn.innerText = "Marking...";
            await updateDoc(doc(db, "orders", orderId), { paid: true });
            await loadData();
        };

        window.changeFlavor = (orderId, currentFlavor) => {
            document.getElementById('flavorModal').dataset.orderId = orderId;
            document.getElementById('flavorSelect').value = currentFlavor;
            document.getElementById('flavorModal').classList.remove('hidden');
        };

        window.confirmChangeFlavor = async () => {
            const modal = document.getElementById('flavorModal');
            const orderId = modal.dataset.orderId;
            const newFlavor = document.getElementById('flavorSelect').value;
            await updateDoc(doc(db, "orders", orderId), { flavor: newFlavor });
            modal.classList.add('hidden');
            showToast("Flavor updated!", "success");
            await loadData();
        };

        window.closeFlavorModal = () => document.getElementById('flavorModal').classList.add('hidden');

        window.editCustomerName = (orderId, currentName) => {
            document.getElementById('nameModal').dataset.orderId = orderId;
            document.getElementById('newNameInput').value = currentName;
            document.getElementById('nameModal').classList.remove('hidden');
        };

        window.confirmChangeName = async () => {
            const modal = document.getElementById('nameModal');
            const orderId = modal.dataset.orderId;
            const newName = document.getElementById('newNameInput').value.trim();
            if (!newName) {
                showToast("Customer name cannot be empty!", "error");
                return;
            }
            await updateDoc(doc(db, "orders", orderId), { customer: newName });
            modal.classList.add('hidden');
            showToast("Customer name updated!", "success");
            await loadData();
        };

        window.closeNameModal = () => document.getElementById('nameModal').classList.add('hidden');

        window.deleteOrder = (orderId) => {
            document.getElementById('deleteModal').dataset.orderId = orderId;
            document.getElementById('deleteModal').classList.remove('hidden');
        };

        window.confirmDelete = async () => {
            const modal = document.getElementById('deleteModal');
            const orderId = modal.dataset.orderId;
            await deleteDoc(doc(db, "orders", orderId));
            modal.classList.add('hidden');
            showToast("Order deleted.", "success");
            await loadData();
        };

        window.closeDeleteModal = () => document.getElementById('deleteModal').classList.add('hidden');

        window.searchCustomers = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = Object.keys(groupedCustomers)
                .filter(name => name.toLowerCase().includes(term))
                .sort();
            renderCustomerHistory(filtered);
        };

        function showToast(message, type = "info") {
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 left-4 right-4 mx-4 px-6 py-4 rounded-xl shadow-2xl text-white font-bold z-50 text-center sm:left-auto sm:right-4 sm:mx-0 sm:w-auto ${
                type === "success" ? "bg-green-600" : type === "error" ? "bg-red-600" : "bg-blue-600"
            }`;
            toast.innerText = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = "0";
                setTimeout(() => document.body.removeChild(toast), 500);
            }, 3000);
        }

        async function loadData() {
            const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            
            allOrders = [];
            groupedCustomers = {};
            let stats = {
                collectedProfit: 0,
                potentialOwed: 0,
                totalRevenue: 0,
                totalPacks: 0,
                flavors: { Chilli: 0, Medium: 0 },
                customers: {},
                salesByDate: {}
            };
            
            let debtHTML = "";

            querySnapshot.forEach((orderDoc) => {
                const data = orderDoc.data();
                const id = orderDoc.id;
                const dateKey = data.timestamp.toDate().toDateString();

                allOrders.push({ id, ...data });

                if (!groupedCustomers[data.customer]) groupedCustomers[data.customer] = [];
                groupedCustomers[data.customer].push({ id, ...data });

                stats.totalRevenue += data.totalSales;
                stats.totalPacks += data.qty;
                stats.flavors[data.flavor] += data.qty;
                stats.customers[data.customer] = (stats.customers[data.customer] || 0) + data.totalSales;
                stats.salesByDate[dateKey] = (stats.salesByDate[dateKey] || 0) + data.totalSales;

                if (data.paid) {
                    stats.collectedProfit += data.totalProfit;
                } else {
                    stats.potentialOwed += data.totalSales;
                    debtHTML += `
                        <div class="bg-red-900/30 border border-red-600/50 p-4 rounded-xl flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-3 shadow-lg">
                            <div>
                                <p class="font-bold text-red-300">${data.customer}</p>
                                <p class="text-xs text-red-400">OWES R${data.totalSales} ‚Ä¢ ${data.flavor} √ó ${data.qty}</p>
                            </div>
                            <button onclick="markAsPaid('${id}')" class="w-full sm:w-auto bg-green-600 hover:bg-green-500 text-white text-xs px-6 py-3 rounded-full font-bold uppercase shadow">Mark Paid</button>
                        </div>`;
                }
            });

            const topCustEntry = Object.entries(stats.customers).sort((a,b) => b[1] - a[1])[0];
            const topCust = topCustEntry ? topCustEntry[0] : "N/A";

            document.getElementById('stat-profit').innerText = `R${stats.collectedProfit.toFixed(2)}`;
            document.getElementById('stat-owed').innerText = `R${stats.potentialOwed.toFixed(2)}`;
            document.getElementById('stat-revenue').innerText = `R${stats.totalRevenue.toFixed(2)}`;
            document.getElementById('stat-top').innerText = topCust;
            document.getElementById('stat-flavor').innerText = stats.flavors.Chilli >= stats.flavors.Medium ? "Chilli üå∂Ô∏è" : "Medium üêÇ";
            document.getElementById('stat-packs').innerText = stats.totalPacks;
            
            document.getElementById('debtorList').innerHTML = debtHTML || "<p class='text-gray-500 text-center py-8 italic'>No outstanding payments üéâ</p>";

            const sortedCustomers = Object.keys(groupedCustomers).sort();
            renderCustomerHistory(sortedCustomers);
            renderCharts(stats);
        }

        function renderCustomerHistory(customerList) {
            let historyHTML = "";
            if (customerList.length === 0) {
                historyHTML = '<div class="p-8 text-center text-gray-500 italic">No customers found</div>';
            } else {
                customerList.forEach(customer => {
                    const orders = groupedCustomers[customer];
                    const totalSpent = orders.reduce((sum, o) => sum + o.totalSales, 0);
                    const totalOwed = orders.filter(o => !o.paid).reduce((sum, o) => sum + o.totalSales, 0);

                    historyHTML += `
                        <div class="mb-6 bg-zinc-800/30 rounded-2xl overflow-hidden shadow-lg">
                            <div class="p-5 bg-zinc-800/50 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                                <div>
                                    <p class="font-bold text-xl text-yellow-400">${customer}</p>
                                    <p class="text-sm text-gray-400">Total: R${totalSpent} ${totalOwed > 0 ? `‚Ä¢ Owes R${totalOwed}` : ''}</p>
                                </div>
                                <p class="text-sm text-gray-500">${orders.length} order${orders.length > 1 ? 's' : ''}</p>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full min-w-[600px]">
                                    <tbody>`;
                    orders.sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate()).forEach(order => {
                        const date = order.timestamp.toDate().toLocaleDateString();
                        historyHTML += `
                            <tr class="border-b border-white/5 hover:bg-white/5">
                                <td class="p-4 text-sm">${date}</td>
                                <td class="p-4 text-sm">${order.flavor} √ó ${order.qty}</td>
                                <td class="p-4 text-sm">R${order.totalSales}</td>
                                <td class="p-4 text-sm"><span class="${order.paid ? 'text-green-400' : 'text-yellow-400'} font-bold">${order.paid ? '‚úÖ Paid' : '‚è≥ Pending'}</span></td>
                                <td class="p-4 text-right">
                                    <div class="flex flex-wrap justify-end gap-2">
                                        <button onclick="editCustomerName('${order.id}', '${order.customer.replace(/'/g, "\\'")}')" class="text-purple-400 hover:text-purple-300 text-xs px-2 py-1">Name</button>
                                        <button onclick="changeFlavor('${order.id}', '${order.flavor}')" class="text-blue-400 hover:text-blue-300 text-xs px-2 py-1">Flavor</button>
                                        <button onclick="deleteOrder('${order.id}')" class="text-red-400 hover:text-red-300 text-xs px-2 py-1">Delete</button>
                                    </div>
                                </td>
                            </tr>`;
                    });
                    historyHTML += `
                                    </tbody>
                                </table>
                            </div>
                        </div>`;
                });
            }
            document.getElementById('customerHistory').innerHTML = historyHTML;
        }

        function renderCharts(stats) {
            // Charts unchanged (they are already responsive)
            const flavorCtx = document.getElementById('flavorChart').getContext('2d');
            if (window.flavorChartInstance) window.flavorChartInstance.destroy();
            window.flavorChartInstance = new Chart(flavorCtx, {
                type: 'doughnut',
                data: { labels: ['Chilli üå∂Ô∏è', 'Medium üêÇ'], datasets: [{ data: [stats.flavors.Chilli, stats.flavors.Medium], backgroundColor: ['#EF4444', '#3B82F6'], borderWidth: 0 }] },
                options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#D1D5DB' } } } }
            });

            const sortedCust = Object.entries(stats.customers).sort((a,b) => b[1]-a[1]).slice(0,5);
            const custCtx = document.getElementById('topCustomersChart').getContext('2d');
            if (window.topCustChart) window.topCustChart.destroy();
            window.topCustChart = new Chart(custCtx, {
                type: 'bar',
                data: { labels: sortedCust.map(c => c[0]), datasets: [{ label: 'Sales (R)', data: sortedCust.map(c => c[1]), backgroundColor: '#FBBF24' }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#D1D5DB' } }, x: { ticks: { color: '#D1D5DB' } } } }
            });

            const dates = Object.keys(stats.salesByDate).sort((a,b) => new Date(a) - new Date(b)).slice(-10);
            const salesData = dates.map(d => stats.salesByDate[d]);
            const salesCtx = document.getElementById('salesOverTimeChart').getContext('2d');
            if (window.salesChart) window.salesChart.destroy();
            window.salesChart = new Chart(salesCtx, {
                type: 'line',
                data: { labels: dates.map(d => new Date(d).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' })), datasets: [{ label: 'Daily Sales (R)', data: salesData, borderColor: '#10B981', backgroundColor: 'rgba(16, 185, 129, 0.2)', fill: true, tension: 0.4 }] },
                options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#D1D5DB' } }, x: { ticks: { color: '#D1D5DB' } } } }
            });
        }

        window.onload = loadData;
    </script>
</head>
<body class="bg-gradient-to-br from-gray-900 via-black to-gray-900 text-gray-200 font-sans antialiased min-h-screen">

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <h1 class="text-3xl sm:text-4xl font-black text-yellow-400 italic text-center mb-8 tracking-wider">KTY HALAAL BILTONG</h1>

        <!-- Stats -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-4 sm:p-5 rounded-2xl border border-white/10 shadow-xl text-center">
                <p class="text-xs uppercase text-gray-400 tracking-widest">Profit</p>
                <p id="stat-profit" class="text-lg sm:text-2xl font-black text-green-400 mt-1">R0.00</p>
            </div>
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-4 sm:p-5 rounded-2xl border border-white/10 shadow-xl text-center">
                <p class="text-xs uppercase text-gray-400 tracking-widest">Owed</p>
                <p id="stat-owed" class="text-lg sm:text-2xl font-black text-red-400 mt-1">R0.00</p>
            </div>
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-4 sm:p-5 rounded-2xl border border-white/10 shadow-xl text-center">
                <p class="text-xs uppercase text-gray-400 tracking-widest">Revenue</p>
                <p id="stat-revenue" class="text-lg sm:text-2xl font-black text-cyan-400 mt-1">R0.00</p>
            </div>
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-4 sm:p-5 rounded-2xl border border-white/10 shadow-xl text-center">
                <p class="text-xs uppercase text-gray-400 tracking-widest">Top Customer</p>
                <p id="stat-top" class="text-sm sm:text-lg font-black text-yellow-400 mt-1 truncate">---</p>
            </div>
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-4 sm:p-5 rounded-2xl border border-white/10 shadow-xl text-center">
                <p class="text-xs uppercase text-gray-400 tracking-widest">Best Flavor</p>
                <p id="stat-flavor" class="text-lg sm:text-2xl font-black text-blue-400 mt-1">---</p>
            </div>
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-4 sm:p-5 rounded-2xl border border-white/10 shadow-xl text-center">
                <p class="text-xs uppercase text-gray-400 tracking-widest">Packs Sold</p>
                <p id="stat-packs" class="text-lg sm:text-2xl font-black text-purple-400 mt-1">0</p>
            </div>
        </div>

        <!-- New Order Form -->
        <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-6 sm:p-8 rounded-3xl border border-yellow-500/30 shadow-2xl mb-8">
            <h2 class="text-2xl font-black text-yellow-400 mb-6 text-center sm:text-left">Log New Order</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <input id="customer" type="text" placeholder="Customer Name" class="bg-black/50 border border-white/20 p-4 rounded-2xl focus:border-yellow-400 outline-none text-gray-200">
                <input id="phone" type="text" placeholder="Phone / WhatsApp" class="bg-black/50 border border-white/20 p-4 rounded-2xl focus:border-yellow-400 outline-none text-gray-200">
            </div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <select id="flavor" class="bg-black/50 border border-white/20 p-4 rounded-2xl text-gray-200">
                    <option value="Chilli">Chilli üå∂Ô∏è</option>
                    <option value="Medium">Medium üêÇ</option>
                </select>
                <input id="qty" type="number" min="1" placeholder="Quantity" class="bg-black/50 border border-white/20 p-4 rounded-2xl text-center text-gray-200">
            </div>
            <label class="flex items-center gap-4 mt-5 bg-black/30 p-4 rounded-2xl border border-white/10 cursor-pointer">
                <input id="isPaid" type="checkbox" class="w-6 h-6 accent-green-500 rounded">
                <span class="font-bold uppercase text-gray-300">Paid upfront?</span>
            </label>
            <button onclick="saveOrder()" class="w-full mt-6 bg-gradient-to-r from-yellow-500 to-amber-600 hover:from-yellow-400 hover:to-amber-500 text-black font-bold py-4 rounded-2xl uppercase tracking-wider shadow-xl">Add Order</button>
        </div>

        <!-- Pending Payments -->
        <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-6 sm:p-8 rounded-3xl border border-red-600/20 shadow-2xl mb-8">
            <h3 class="text-xl font-black text-red-400 uppercase tracking-widest mb-6 text-center sm:text-left">Pending Payments</h3>
            <div id="debtorList" class="space-y-3"></div>
        </div>

        <!-- Charts -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-6 rounded-3xl border border-white/10 shadow-2xl">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-4 text-center">Flavor Split</h3>
                <canvas id="flavorChart"></canvas>
            </div>
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-6 rounded-3xl border border-white/10 shadow-2xl">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-4 text-center">Top 5 Customers</h3>
                <canvas id="topCustomersChart"></canvas>
            </div>
            <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-6 rounded-3xl border border-white/10 shadow-2xl">
                <h3 class="text-sm font-black text-gray-400 uppercase tracking-widest mb-4 text-center">Sales Trend (Last 10 Days)</h3>
                <canvas id="salesOverTimeChart"></canvas>
            </div>
        </div>

        <!-- Customer History -->
        <div class="bg-gradient-to-br from-zinc-800 to-zinc-900 p-6 sm:p-8 rounded-3xl border border-white/10 shadow-2xl">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                <h3 class="text-xl font-black text-gray-300 uppercase tracking-widest">Customer History</h3>
                <input id="searchInput" onkeyup="searchCustomers()" type="text" placeholder="Search customer..." class="w-full sm:w-64 bg-black/50 border border-white/20 px-4 py-3 rounded-xl focus:border-yellow-400 outline-none text-gray-200">
            </div>
            <div id="customerHistory" class="space-y-6"></div>
        </div>

        <!-- Modals remain the same -->
        <!-- Edit Name Modal -->
        <div id="nameModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 px-4">
            <div class="bg-zinc-900 p-6 rounded-3xl border border-purple-500/50 shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-black text-purple-400 mb-5 text-center">Edit Customer Name</h3>
                <input id="newNameInput" type="text" class="w-full bg-black/50 border border-white/20 p-4 rounded-2xl focus:border-purple-400 outline-none text-gray-200 mb-6">
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="confirmChangeName()" class="bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-2xl uppercase">Save</button>
                    <button onclick="closeNameModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-2xl uppercase">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Edit Flavor Modal -->
        <div id="flavorModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 px-4">
            <div class="bg-zinc-900 p-6 rounded-3xl border border-yellow-500/50 shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-black text-yellow-400 mb-5 text-center">Change Flavor</h3>
                <select id="flavorSelect" class="w-full bg-black/50 border border-white/20 p-4 rounded-2xl text-gray-200 mb-6">
                    <option value="Chilli">Chilli üå∂Ô∏è</option>
                    <option value="Medium">Medium üêÇ</option>
                </select>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="confirmChangeFlavor()" class="bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-2xl uppercase">Save</button>
                    <button onclick="closeFlavorModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-2xl uppercase">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Delete Modal -->
        <div id="deleteModal" class="hidden fixed inset-0 bg-black/80 flex items-center justify-center z-50 px-4">
            <div class="bg-zinc-900 p-6 rounded-3xl border border-red-500/50 shadow-2xl w-full max-w-sm">
                <h3 class="text-xl font-black text-red-400 mb-5 text-center">Delete Order?</h3>
                <p class="text-gray-300 mb-8 text-center">This action cannot be undone.</p>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="confirmDelete()" class="bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded-2xl uppercase">Delete</button>
                    <button onclick="closeDeleteModal()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-2xl uppercase">Cancel</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>