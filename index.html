<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KTY HALAAL BILTONG | Pro Manager</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js-adapter-date-fns/3.0.0/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['"Plus Jakarta Sans"', 'sans-serif'] },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.03)",
                        glassBorder: "rgba(255, 255, 255, 0.08)",
                        glassHover: "rgba(255, 255, 255, 0.08)",
                        accent: "#F59E0B", 
                        accentHover: "#D97706",
                        success: "#10B981",
                        danger: "#EF4444"
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                    },
                    keyframes: {
                        slideUp: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            background-color: #09090b; 
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(245, 158, 11, 0.08), transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(16, 185, 129, 0.05), transparent 25%);
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Glassmorphism Utilities */
        .glass-panel {
            background: rgba(24, 24, 27, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        .glass-input {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255,255,255,0.08);
            color: white;
            transition: all 0.2s ease;
        }
        .glass-input:focus {
            border-color: #F59E0B;
            box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.1);
            outline: none;
            background: rgba(0, 0, 0, 0.6);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #09090b; }
        ::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3f3f46; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #F59E0B;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Table Card View */
        .mobile-card { display: none; }
        @media (max-width: 768px) {
            .desktop-table { display: none; }
            .mobile-card { display: block; }
        }
    </style>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, updateDoc, doc, deleteDoc, increment, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyC8VkN2_icMo9LEM1TbPjDf_kckmSI41z0",
            authDomain: "biltong-fd731.firebaseapp.com",
            projectId: "biltong-fd731",
            storageBucket: "biltong-fd731.firebasestorage.app",
            messagingSenderId: "922275664562",
            appId: "1:922275664562:web:c07db5cd9d5a90b936afab",
            measurementId: "G-ZMXEPCM0VH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // --- App State ---
        let appSettings = JSON.parse(localStorage.getItem('ktySettings')) || {
            pricePerPack: 35,
            costPerPack: 16.25,
            stockChilli: 50,
            stockMedium: 50,
            lowStockThreshold: 10
        };

        let allOrders = [];
        let inventory = { ...appSettings }; // Local cache
        let currentFilter = 'all'; 
        let dateFilter = 'all'; // all, thisMonth, lastMonth
        let selectedOrderIds = new Set();
        let searchQuery = ""; // NEW: Search State

        // --- Helper Functions ---
        
        function formatCurrency(amount) {
            return `R${parseFloat(amount).toFixed(2)}`;
        }

        function formatDate(timestamp) {
            if(!timestamp) return '-';
            return new Date(timestamp.seconds * 1000).toLocaleDateString(undefined, {
                day: 'numeric', month: 'short', year: '2-digit'
            });
        }

        window.showToast = (message, type = "info") => {
            const toast = document.createElement('div');
            const colors = {
                success: "bg-emerald-600 border-emerald-500",
                error: "bg-red-600 border-red-500",
                info: "bg-blue-600 border-blue-500",
                warning: "bg-amber-600 border-amber-500"
            };
            const icons = {
                success: "ph-check-circle",
                error: "ph-warning-circle",
                info: "ph-info",
                warning: "ph-warning"
            };

            toast.className = `fixed bottom-6 left-1/2 transform -translate-x-1/2 px-6 py-4 rounded-xl border shadow-2xl text-white font-medium z-[60] flex items-center gap-3 transition-all duration-300 translate-y-20 opacity-0 ${colors[type]} min-w-[300px] justify-center`;
            toast.innerHTML = `<i class="ph ${icons[type]} text-xl"></i> <span>${message}</span>`;
            
            document.body.appendChild(toast);
            
            requestAnimationFrame(() => {
                toast.classList.remove('translate-y-20', 'opacity-0');
            });

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        };

        // --- Inventory Management ---
        
        window.updateStock = async (flavor, change) => {
            const key = flavor === 'Chilli' ? 'stockChilli' : 'stockMedium';
            const newStock = inventory[key] + change;
            
            if(newStock < 0) return showToast("Not enough stock!", "error");

            // Optimistic Update
            inventory[key] = newStock;
            updateInventoryUI();

            // Persist to DB (using a specific 'config' doc)
            try {
                await setDoc(doc(db, "config", "inventory"), {
                    stockChilli: inventory.stockChilli,
                    stockMedium: inventory.stockMedium
                }, { merge: true });
                
                // Update local settings
                appSettings[key] = newStock;
                localStorage.setItem('ktySettings', JSON.stringify(appSettings));
            } catch(e) {
                showToast("Failed to update stock", "error");
            }
        };

        function updateInventoryUI() {
            document.getElementById('inv-chilli').innerText = inventory.stockChilli;
            document.getElementById('inv-medium').innerText = inventory.stockMedium;
            
            // Low stock warnings
            const chilliEl = document.getElementById('inv-chilli-wrap');
            const mediumEl = document.getElementById('inv-medium-wrap');
            
            chilliEl.className = inventory.stockChilli <= appSettings.lowStockThreshold 
                ? "text-red-400 animate-pulse" : "text-gray-400";
            mediumEl.className = inventory.stockMedium <= appSettings.lowStockThreshold 
                ? "text-red-400 animate-pulse" : "text-gray-400";
        }

        // --- Core Functions ---

        window.saveOrder = async () => {
            const customer = document.getElementById('customer').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const flavor = document.getElementById('flavor').value;
            const qty = parseInt(document.getElementById('qty').value);
            const isPaid = document.getElementById('isPaid').checked;
            const notes = document.getElementById('notes').value.trim();
            
            if(!customer || isNaN(qty) || qty <= 0) {
                showToast("Please enter customer name and quantity.", "error");
                return;
            }

            // Check Stock
            const stockKey = flavor === 'Chilli' ? 'stockChilli' : 'stockMedium';
            if(inventory[stockKey] < qty) {
                return showToast(`Not enough ${flavor} stock! Only ${inventory[stockKey]} left.`, "error");
            }

            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i> Processing...`;

            try {
                // 1. Save Order
                await addDoc(collection(db, "orders"), {
                    customer, phone, flavor, qty, notes,
                    totalSales: qty * appSettings.pricePerPack,
                    totalProfit: qty * (appSettings.pricePerPack - appSettings.costPerPack),
                    paid: isPaid,
                    timestamp: new Date()
                });

                // 2. Deduct Stock
                await updateStock(flavor, -qty * -1); // Logic handled inside updateStock to invert for deduction

                showToast("Order logged successfully!", "success");
                
                // Reset form
                document.getElementById('customer').value = '';
                document.getElementById('phone').value = '';
                document.getElementById('qty').value = '1';
                document.getElementById('notes').value = '';
                document.getElementById('isPaid').checked = false;
                
                await loadData();
            } catch (e) { 
                console.error(e);
                showToast("Error saving order: " + e.message, "error"); 
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        };

        window.togglePaid = async (orderId, currentState) => {
            try {
                await updateDoc(doc(db, "orders", orderId), { paid: !currentState });
                showToast("Payment status updated", "success");
                await loadData();
            } catch(e) { showToast("Update failed", "error"); }
        };

        window.deleteOrder = (orderId) => {
            if(confirm("Are you sure you want to delete this order?")) {
                performDelete(orderId);
            }
        };

        async function performDelete(orderId) {
            try {
                // Optional: Restore stock? For simplicity, we won't auto-restore to avoid complications if stock changed since sale.
                // Ideally, you'd fetch the order qty first, then delete, then restore.
                await deleteDoc(doc(db, "orders", orderId));
                showToast("Order deleted.", "success");
                await loadData();
            } catch(e) { showToast("Could not delete", "error"); }
        }

        window.bulkDelete = async () => {
            if(selectedOrderIds.size === 0) return;
            if(!confirm(`Delete ${selectedOrderIds.size} selected orders?`)) return;

            const btn = document.getElementById('bulkActionBtn');
            btn.innerHTML = `<i class="ph ph-spinner animate-spin"></i>`;
            
            let failed = 0;
            for(const id of selectedOrderIds) {
                try { await deleteDoc(doc(db, "orders", id)); } 
                catch(e) { failed++; }
            }
            
            showToast(failed > 0 ? `Deleted with ${failed} errors` : "Orders deleted", failed > 0 ? "warning" : "success");
            selectedOrderIds.clear();
            await loadData();
        };

        window.toggleSelection = (id) => {
            if(selectedOrderIds.has(id)) selectedOrderIds.delete(id);
            else selectedOrderIds.add(id);
            renderBulkActions();
        };

        function renderBulkActions() {
            const bar = document.getElementById('bulkActionBar');
            if(selectedOrderIds.size > 0) {
                bar.classList.remove('translate-y-full');
                document.getElementById('bulkCount').innerText = selectedOrderIds.size;
            } else {
                bar.classList.add('translate-y-full');
            }
        }

        window.editOrder = (orderId) => {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            document.getElementById('editModal').dataset.orderId = orderId;
            document.getElementById('editCustomer').value = order.customer;
            document.getElementById('editFlavor').value = order.flavor;
            document.getElementById('editQty').value = order.qty;
            document.getElementById('editNotes').value = order.notes || '';
            document.getElementById('editPaid').checked = order.paid;
            
            document.getElementById('editModal').classList.remove('hidden');
        };

        window.saveEdit = async () => {
            const modal = document.getElementById('editModal');
            const orderId = modal.dataset.orderId;
            const customer = document.getElementById('editCustomer').value.trim();
            const flavor = document.getElementById('editFlavor').value;
            const qty = parseInt(document.getElementById('editQty').value);
            const notes = document.getElementById('editNotes').value.trim();
            const paid = document.getElementById('editPaid').checked;

            if(!customer || qty <= 0) return showToast("Invalid input", "error");

            try {
                await updateDoc(doc(db, "orders", orderId), {
                    customer, flavor, qty, notes, paid,
                    totalSales: qty * appSettings.pricePerPack,
                    totalProfit: qty * (appSettings.pricePerPack - appSettings.costPerPack)
                });
                modal.classList.add('hidden');
                showToast("Order updated!", "success");
                await loadData();
            } catch(e) { showToast("Update failed", "error"); }
        };

        window.setFilter = (filterType) => {
            currentFilter = filterType;
            document.querySelectorAll('.filter-btn').forEach(b => {
                if(b.dataset.filter === filterType) {
                    b.classList.remove('bg-zinc-800', 'text-gray-400');
                    b.classList.add('bg-amber-500', 'text-black');
                } else {
                    b.classList.add('bg-zinc-800', 'text-gray-400');
                    b.classList.remove('bg-amber-500', 'text-black');
                }
            });
            renderUI();
        };

        window.setDateFilter = (filter) => {
            dateFilter = filter;
            document.getElementById('dateFilterLabel').innerText = filter === 'all' ? 'All Time' : filter === 'thisMonth' ? 'This Month' : 'Last Month';
            renderUI();
        };

        // --- Search Functionality (FIXED & ENHANCED) ---
        window.handleSearch = (e) => {
            searchQuery = e.target.value.toLowerCase().trim();
            renderUI();
            updateSearchUI();
        };

        window.clearSearch = () => {
            searchQuery = "";
            document.getElementById('searchInput').value = "";
            renderUI();
            updateSearchUI();
        };

        function updateSearchUI() {
            const clearBtn = document.getElementById('clearSearchBtn');
            if(searchQuery.length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }

        window.exportToCSV = () => {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Date,Customer,Phone,Flavor,Qty,Total,Status,Notes\n";
            
            const filtered = getFilteredOrders();
            
            filtered.forEach(o => {
                const date = o.timestamp.toDate().toLocaleDateString();
                const status = o.paid ? "PAID" : "PENDING";
                const safeNotes = `"${(o.notes || "").replace(/"/g, '""')}"`;
                const row = `${date},${o.customer},${o.phone || ''},${o.flavor},${o.qty},${o.totalSales},${status},${safeNotes}`;
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `kty_sales_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.backupData = async () => {
            const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);
            const data = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
            const blob = new Blob([JSON.stringify(data, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `kty_backup_${new Date().toISOString().slice(0,10)}.json`;
            link.click();
        };

        // --- WhatsApp Integration ---
        window.openWhatsApp = (order) => {
            let msg = `Hi ${order.customer}, this is KTY Biltong. `;
            if(!order.paid) msg += `Regarding your pending order of ${order.qty}x ${order.flavor} (R${order.totalSales}). `;
            else msg += `Thanks for your recent order! `;
            
            // Clean phone number (remove non-digits)
            let phone = order.phone ? order.phone.replace(/\D/g,'') : '';
            
            if(phone) {
                window.open(`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`, '_blank');
            } else {
                showToast("No phone number saved", "warning");
            }
        };

        // --- Data Loading & Filtering ---

        function getFilteredOrders() {
            const now = new Date();
            let start = new Date(0); // Beginning of time
            
            if(dateFilter === 'thisMonth') {
                start = new Date(now.getFullYear(), now.getMonth(), 1);
            } else if (dateFilter === 'lastMonth') {
                start = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                // End of last month is effectively start of this month
            }

            // Filter Logic
            return allOrders.filter(o => {
                const oDate = o.timestamp.toDate();
                
                // Date Filter
                let datePass = true;
                if(dateFilter === 'thisMonth') {
                    datePass = oDate >= start;
                } else if (dateFilter === 'lastMonth') {
                    datePass = oDate >= start && oDate < new Date(now.getFullYear(), now.getMonth(), 1);
                }

                // Status Filter
                let statusPass = true;
                if(currentFilter === 'pending') statusPass = !o.paid;
                if(currentFilter === 'paid') statusPass = o.paid;

                // ENHANCED: Search Filter (Customer, Phone, Flavor, Notes)
                let searchPass = true;
                if (searchQuery) {
                    const q = searchQuery;
                    const matchName = o.customer.toLowerCase().includes(q);
                    const matchPhone = o.phone && o.phone.includes(q);
                    const matchFlavor = o.flavor.toLowerCase().includes(q);
                    const matchNotes = o.notes && o.notes.toLowerCase().includes(q);
                    
                    searchPass = matchName || matchPhone || matchFlavor || matchNotes;
                }

                return datePass && statusPass && searchPass;
            });
        }

        async function loadData() {
            // Show loader
            const loader = document.getElementById('loadingOverlay');
            loader.classList.remove('hidden');

            try {
                // 1. Fetch Inventory
                const invDoc = await getDoc(doc(db, "config", "inventory"));
                if(invDoc.exists()) {
                    inventory = { ...appSettings, ...invDoc.data() };
                    // Sync back to local settings to keep consistent
                    appSettings.stockChilli = inventory.stockChilli;
                    appSettings.stockMedium = inventory.stockMedium;
                }
                updateInventoryUI();

                // 2. Fetch Orders
                const q = query(collection(db, "orders"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                
                allOrders = [];
                querySnapshot.forEach((doc) => {
                    allOrders.push({ id: doc.id, ...doc.data() });
                });

                renderUI();

            } catch (e) {
                console.error(e);
                showToast("Error loading data", "error");
            } finally {
                setTimeout(() => loader.classList.add('hidden'), 500);
            }
        }

        function renderUI() {
            const orders = getFilteredOrders();
            
            // Calculate Stats
            let stats = {
                collectedProfit: 0,
                potentialOwed: 0,
                totalRevenue: 0,
                totalPacks: 0,
                flavors: { Chilli: 0, Medium: 0 },
                customers: {}, 
            };

            let debtHTML = "";

            orders.forEach(o => {
                stats.totalRevenue += o.totalSales;
                stats.totalPacks += o.qty;
                stats.flavors[o.flavor] = (stats.flavors[o.flavor] || 0) + o.qty;
                stats.customers[o.customer] = (stats.customers[o.customer] || 0) + o.totalSales;

                if (o.paid) stats.collectedProfit += o.totalProfit;
                else {
                    stats.potentialOwed += o.totalSales;
                    if(allOrders.find(x => x.id === o.id).paid === false) {
                         debtHTML += `
                        <div class="p-3 rounded-xl border border-white/5 bg-white/5 flex justify-between items-center mb-2 animate-fade-in">
                            <div>
                                <div class="font-bold text-sm text-gray-200">${o.customer}</div>
                                <div class="text-xs text-red-400">R${o.totalSales.toFixed(2)}</div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="togglePaid('${o.id}', false)" class="bg-emerald-500/20 hover:bg-emerald-500 text-emerald-400 hover:text-white p-2 rounded-lg transition-colors" title="Mark Paid"><i class="ph ph-check"></i></button>
                                <button onclick="openWhatsApp(${JSON.stringify(o).replace(/"/g, '&quot;')})" class="bg-green-600/20 hover:bg-green-600 text-green-400 hover:text-white p-2 rounded-lg transition-colors" title="WhatsApp"><i class="ph ph-whatsapp-logo"></i></button>
                            </div>
                        </div>`;
                    }
                }
            });

            // Render Stats Cards
            document.getElementById('stat-profit').innerText = formatCurrency(stats.collectedProfit);
            document.getElementById('stat-owed').innerText = formatCurrency(stats.potentialOwed);
            document.getElementById('stat-revenue').innerText = formatCurrency(stats.totalRevenue);
            document.getElementById('stat-packs').innerText = stats.totalPacks;
            
            // Render Sidebar Debts (Show top 15 owing)
            const globalDebtors = allOrders.filter(o => !o.paid).sort((a,b) => b.timestamp.toDate() - a.timestamp.toDate()).slice(0, 15);
            let globalDebtHTML = "";
            globalDebtors.forEach(o => {
                globalDebtHTML += `
                    <div class="p-3 rounded-xl border-l-4 border-l-red-500 bg-white/5 flex justify-between items-center mb-2 group hover:bg-white/10 transition-colors">
                        <div class="overflow-hidden">
                            <div class="font-bold text-sm text-gray-200 truncate">${o.customer}</div>
                            <div class="text-xs text-gray-400 truncate">${o.qty}x ${o.flavor}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-red-400 font-bold text-sm">R${o.totalSales.toFixed(2)}</span>
                            <button onclick="openWhatsApp(${JSON.stringify(o).replace(/"/g, '&quot;')})" class="text-green-400 hover:text-white opacity-0 group-hover:opacity-100 transition-opacity"><i class="ph ph-whatsapp-logo text-lg"></i></button>
                        </div>
                    </div>`;
            });
            
            const debtContainer = document.getElementById('debtorList');
            if(globalDebtors.length === 0) {
                debtContainer.innerHTML = `<div class="text-center py-4 opacity-50 text-xs"><i class="ph ph-smiley text-2xl mb-1"></i><p>All settled up!</p></div>`;
            } else {
                debtContainer.innerHTML = globalDebtHTML;
            }

            renderHistory(orders);
            renderCharts(stats);
        }

        function renderHistory(orders) {
            const container = document.getElementById('customerHistory');
            selectedOrderIds.clear(); // Reset selection on re-render
            renderBulkActions();

            if (orders.length === 0) {
                if(searchQuery) {
                    container.innerHTML = `<div class="p-8 text-center text-gray-500 flex flex-col items-center animate-fade-in">
                        <i class="ph ph-magnifying-glass text-4xl mb-3 opacity-20"></i>
                        <p>No results found for "<span class="text-white font-bold">${searchQuery}</span>"</p>
                        <button onclick="clearSearch()" class="mt-4 text-amber-500 text-sm font-bold hover:text-amber-400">Clear Search</button>
                    </div>`;
                } else {
                    container.innerHTML = `<div class="p-8 text-center text-gray-500 flex flex-col items-center animate-fade-in"><i class="ph ph-magnifying-glass text-4xl mb-3 opacity-20"></i><p>No orders found.</p></div>`;
                }
                return;
            }

            let html = "";
            
            // Group by Date for headers
            const grouped = {};
            orders.forEach(o => {
                const d = o.timestamp.toDate().toDateString();
                if(!grouped[d]) grouped[d] = [];
                grouped[d].push(o);
            });

            Object.keys(grouped).forEach(dateStr => {
                html += `<div class="text-xs font-bold text-gray-500 uppercase tracking-widest mt-6 mb-2 pl-2 sticky top-0 bg-[#09090b]/90 backdrop-blur z-10 py-1">${dateStr}</div>`;
                
                grouped[dateStr].forEach((order, idx) => {
                    const statusClass = order.paid ? "text-emerald-400 bg-emerald-400/10 border-emerald-400/20" : "text-amber-400 bg-amber-400/10 border-amber-400/20";
                    const statusText = order.paid ? "PAID" : "PENDING";
                    const isSelected = selectedOrderIds.has(order.id) ? 'bg-amber-500/10 border-amber-500/50' : '';
                    const rowBg = idx % 2 === 0 ? 'bg-transparent' : 'bg-white/[0.02]';

                    // --- Desktop Table Row ---
                    html += `
                    <div class="desktop-table group flex items-center px-4 py-3 border-b border-white/5 hover:bg-white/5 transition-colors ${rowBg} ${isSelected}">
                        <div class="w-10 px-2">
                            <input type="checkbox" onchange="toggleSelection('${order.id}')" class="w-4 h-4 rounded border-gray-600 bg-transparent text-amber-500 focus:ring-offset-0 focus:ring-0">
                        </div>
                        <div class="w-24 text-xs text-gray-500 font-mono">${formatDate(order.timestamp)}</div>
                        <div class="flex-1">
                            <div class="font-bold text-sm text-gray-200">${order.customer}</div>
                            <div class="text-xs text-gray-500">${order.flavor} √ó ${order.qty}</div>
                        </div>
                        <div class="w-24 text-right font-mono text-sm text-gray-300">R${order.totalSales}</div>
                        <div class="w-24 px-2">
                            <span class="px-2 py-1 rounded text-[10px] font-bold border ${statusClass}">${statusText}</span>
                        </div>
                        <div class="w-32 flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            ${order.phone ? `<button onclick="openWhatsApp(${JSON.stringify(order).replace(/"/g, '&quot;')})" class="p-1.5 hover:bg-green-500/20 text-green-400 rounded-lg" title="WhatsApp"><i class="ph ph-whatsapp-logo text-lg"></i></button>` : ''}
                            <button onclick="editOrder('${order.id}')" class="p-1.5 hover:bg-white/10 text-blue-400 rounded-lg" title="Edit"><i class="ph ph-pencil-simple"></i></button>
                            <button onclick="deleteOrder('${order.id}')" class="p-1.5 hover:bg-red-500/20 text-red-400 rounded-lg" title="Delete"><i class="ph ph-trash"></i></button>
                        </div>
                    </div>`;

                    // --- Mobile Card View ---
                    html += `
                    <div class="mobile-card p-4 mb-4 rounded-2xl border border-white/5 bg-white/[0.02] relative animate-slide-up">
                        <div class="flex justify-between items-start mb-3">
                            <div>
                                <h4 class="font-bold text-white text-lg">${order.customer}</h4>
                                <p class="text-xs text-gray-500 font-mono">${formatDate(order.timestamp)}</p>
                            </div>
                            <span class="px-2 py-1 rounded text-[10px] font-bold border ${statusClass}">${statusText}</span>
                        </div>
                        <div class="flex justify-between items-center py-2 border-t border-white/5">
                            <div class="text-sm text-gray-300">
                                ${order.flavor} <span class="text-gray-600">√ó</span> ${order.qty}
                            </div>
                            <div class="font-mono font-bold text-white">R${order.totalSales}</div>
                        </div>
                        ${order.notes ? `<div class="mt-2 text-xs text-amber-500/80 bg-amber-500/10 p-2 rounded truncate"><i class="ph ph-note"></i> ${order.notes}</div>` : ''}
                        
                        <div class="mt-4 flex gap-3 justify-end">
                            <input type="checkbox" onchange="toggleSelection('${order.id}')" class="self-center">
                            ${order.phone ? `<button onclick="openWhatsApp(${JSON.stringify(order).replace(/"/g, '&quot;')})" class="flex-1 py-2 rounded-xl bg-green-600/20 text-green-400 text-sm font-bold flex items-center justify-center gap-2"><i class="ph ph-whatsapp-logo text-lg"></i> Chat</button>` : ''}
                            <button onclick="editOrder('${order.id}')" class="flex-1 py-2 rounded-xl bg-blue-600/20 text-blue-400 text-sm font-bold">Edit</button>
                        </div>
                    </div>`;
                });
            });

            container.innerHTML = html;
        }

        function renderCharts(stats) {
            Chart.defaults.color = '#71717a';
            Chart.defaults.font.family = '"Plus Jakarta Sans", sans-serif';
            
            // Flavor Chart
            const flavorCtx = document.getElementById('flavorChart').getContext('2d');
            if (window.flavorChartInstance) window.flavorChartInstance.destroy();
            window.flavorChartInstance = new Chart(flavorCtx, {
                type: 'doughnut',
                data: { 
                    labels: ['Chilli üå∂Ô∏è', 'Medium üêÇ'], 
                    datasets: [{ 
                        data: [stats.flavors.Chilli || 0, stats.flavors.Medium || 0], 
                        backgroundColor: ['#EF4444', '#3B82F6'], 
                        borderWidth: 0,
                        hoverOffset: 4
                    }] 
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { legend: { display: false } } 
                }
            });

            // Top Customers Chart
            const sortedCust = Object.entries(stats.customers).sort((a,b) => b[1]-a[1]).slice(0,5);
            const custCtx = document.getElementById('topCustomersChart').getContext('2d');
            if (window.topCustChart) window.topCustChart.destroy();
            window.topCustChart = new Chart(custCtx, {
                type: 'bar',
                data: { 
                    labels: sortedCust.map(c => c[0]), 
                    datasets: [{ 
                        label: 'Sales', 
                        data: sortedCust.map(c => c[1]), 
                        backgroundColor: '#F59E0B',
                        borderRadius: 4,
                        barThickness: 12
                    }] 
                },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Horizontal Bar
                    plugins: { legend: { display: false } }, 
                    scales: { 
                        x: { display: false }, 
                        y: { grid: { display: false }, border: { display: false }, ticks: {color: '#a1a1aa'} } 
                    } 
                }
            });
        }

        // --- Initialization ---
        window.onload = loadData;
    </script>
</head>
<body class="text-gray-300 min-h-screen pb-24 selection:bg-amber-500/30">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 z-[100] bg-[#09090b] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="loader mb-4"></div>
        <p class="text-gray-500 text-sm font-medium animate-pulse">Syncing Data...</p>
    </div>

    <!-- Header -->
    <header class="sticky top-0 z-50 glass-panel border-b-0 border-t-0 border-l-0 border-r-0 rounded-none px-4 py-3">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-gradient-to-br from-amber-400 to-amber-600 rounded-lg flex items-center justify-center text-black font-black text-xl italic shadow-lg shadow-amber-500/20">K</div>
                <div>
                    <h1 class="text-lg font-black italic text-white tracking-tight leading-none">KTY <span class="text-amber-500">HALAAL</span></h1>
                    <p class="text-[10px] text-gray-500 font-bold tracking-widest uppercase">Manager Pro</p>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="document.getElementById('dateFilterDropdown').classList.toggle('hidden')" class="relative px-3 py-2 rounded-lg bg-zinc-900/50 border border-white/5 text-xs font-bold flex items-center gap-2 hover:bg-zinc-800 transition-colors">
                    <i class="ph ph-calendar-blank"></i> <span id="dateFilterLabel">All Time</span> <i class="ph ph-caret-down"></i>
                </button>
                <!-- Date Dropdown -->
                <div id="dateFilterDropdown" class="hidden absolute top-14 right-2 bg-[#18181b] border border-white/10 rounded-xl shadow-xl p-1 w-40 z-50 flex flex-col">
                    <button onclick="setDateFilter('all')" class="text-left px-3 py-2 text-xs font-bold hover:bg-white/10 rounded-lg text-gray-300">All Time</button>
                    <button onclick="setDateFilter('thisMonth')" class="text-left px-3 py-2 text-xs font-bold hover:bg-white/10 rounded-lg text-gray-300">This Month</button>
                    <button onclick="setDateFilter('lastMonth')" class="text-left px-3 py-2 text-xs font-bold hover:bg-white/10 rounded-lg text-gray-300">Last Month</button>
                </div>

                <button onclick="exportToCSV()" class="p-2 rounded-lg bg-zinc-900/50 border border-white/5 hover:bg-emerald-500/20 hover:text-emerald-400 transition-colors text-gray-400"><i class="ph ph-download-simple text-lg"></i></button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mx-auto px-4 max-w-7xl space-y-6 pt-6">
        
        <!-- Quick Stats Row -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Net Profit</p>
                        <p id="stat-profit" class="text-xl font-black text-white mt-1">R0.00</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-500"><i class="ph ph-trend-up"></i></div>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Outstanding</p>
                        <p id="stat-owed" class="text-xl font-black text-white mt-1">R0.00</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-red-500/10 flex items-center justify-center text-red-500"><i class="ph ph-warning-circle"></i></div>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Total Sales</p>
                        <p id="stat-revenue" class="text-xl font-black text-white mt-1">R0.00</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500"><i class="ph ph-currency-circle-dollar"></i></div>
                </div>
            </div>

            <div class="glass-panel p-4 rounded-2xl relative overflow-hidden">
                <div class="flex items-start justify-between">
                    <div>
                        <p class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Packs Sold</p>
                        <p id="stat-packs" class="text-xl font-black text-white mt-1">0</p>
                    </div>
                    <div class="w-8 h-8 rounded-full bg-amber-500/10 flex items-center justify-center text-amber-500"><i class="ph ph-package"></i></div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Sidebar: Actions & Inventory -->
            <div class="lg:col-span-4 xl:col-span-3 space-y-6">
                
                <!-- Inventory Widget -->
                <div class="glass-panel p-5 rounded-3xl">
                    <h3 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4">Stock Levels</h3>
                    <div class="space-y-3">
                        <div class="bg-black/20 p-3 rounded-xl border border-white/5 flex justify-between items-center" id="inv-chilli-wrap">
                            <span class="font-bold text-sm">Chilli üå∂Ô∏è</span>
                            <span class="font-mono font-bold text-lg" id="inv-chilli">0</span>
                        </div>
                        <div class="flex gap-1 mb-2">
                            <button onclick="updateStock('Chilli', -1)" class="flex-1 py-1 bg-red-500/20 hover:bg-red-500/40 text-red-400 rounded text-xs font-bold">-1</button>
                            <button onclick="updateStock('Chilli', 1)" class="flex-1 py-1 bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-400 rounded text-xs font-bold">+1</button>
                            <button onclick="updateStock('Chilli', 10)" class="flex-1 py-1 bg-blue-500/20 hover:bg-blue-500/40 text-blue-400 rounded text-xs font-bold">+10</button>
                        </div>

                        <div class="bg-black/20 p-3 rounded-xl border border-white/5 flex justify-between items-center" id="inv-medium-wrap">
                            <span class="font-bold text-sm">Medium üêÇ</span>
                            <span class="font-mono font-bold text-lg" id="inv-medium">0</span>
                        </div>
                        <div class="flex gap-1">
                            <button onclick="updateStock('Medium', -1)" class="flex-1 py-1 bg-red-500/20 hover:bg-red-500/40 text-red-400 rounded text-xs font-bold">-1</button>
                            <button onclick="updateStock('Medium', 1)" class="flex-1 py-1 bg-emerald-500/20 hover:bg-emerald-500/40 text-emerald-400 rounded text-xs font-bold">+1</button>
                            <button onclick="updateStock('Medium', 10)" class="flex-1 py-1 bg-blue-500/20 hover:bg-blue-500/40 text-blue-400 rounded text-xs font-bold">+10</button>
                        </div>
                    </div>
                </div>

                <!-- New Order Form -->
                <div class="glass-panel p-6 rounded-3xl border-t border-t-amber-500/30 shadow-lg shadow-amber-900/10">
                    <h2 class="text-lg font-bold text-white mb-5 flex items-center gap-2">
                        <i class="ph ph-plus-circle text-amber-500 text-xl"></i> New Order
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Customer</label>
                            <input id="customer" type="text" placeholder="Name" class="glass-input w-full px-4 py-2.5 rounded-xl text-sm">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Flavor</label>
                                <div class="relative">
                                    <select id="flavor" class="glass-input w-full px-4 py-2.5 rounded-xl text-sm appearance-none cursor-pointer">
                                        <option value="Chilli">Chilli üå∂Ô∏è</option>
                                        <option value="Medium">Medium üêÇ</option>
                                    </select>
                                    <i class="ph ph-caret-down absolute right-4 top-3 text-gray-500 pointer-events-none"></i>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Qty</label>
                                <input id="qty" type="number" min="1" value="1" class="glass-input w-full px-4 py-2.5 rounded-xl text-center text-sm">
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Phone (WhatsApp)</label>
                            <input id="phone" type="tel" placeholder="e.g. 0821234567" class="glass-input w-full px-4 py-2.5 rounded-xl text-sm">
                        </div>

                        <div>
                            <label class="text-xs font-bold text-gray-500 uppercase mb-1 block">Notes</label>
                            <input id="notes" type="text" placeholder="Optional..." class="glass-input w-full px-4 py-2.5 rounded-xl text-sm">
                        </div>

                        <label class="flex items-center justify-between gap-4 bg-white/5 p-3 rounded-xl border border-white/5 cursor-pointer hover:bg-white/10 transition-colors">
                            <span class="text-sm font-semibold text-gray-300">Paid Now?</span>
                            <div class="relative inline-flex items-center cursor-pointer">
                                <input id="isPaid" type="checkbox" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500"></div>
                            </div>
                        </label>

                        <button id="saveBtn" onclick="saveOrder()" class="w-full bg-amber-500 hover:bg-amber-400 text-black font-black py-3.5 rounded-xl uppercase tracking-wider shadow-lg shadow-amber-500/20 transition-all transform active:scale-95 flex items-center justify-center gap-2">
                            <i class="ph ph-receipt text-lg"></i> Log Order
                        </button>
                    </div>
                </div>

                <!-- Pending Debts -->
                <div class="glass-panel p-5 rounded-3xl">
                    <h3 class="text-xs font-bold text-red-400 uppercase tracking-widest mb-4 flex items-center justify-between">
                        <span>Outstanding Debts</span>
                        <span class="text-[10px] bg-red-500/20 px-2 py-0.5 rounded-full" id="debtCount">0</span>
                    </h3>
                    <div id="debtorList" class="space-y-1 max-h-[250px] overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>
            </div>

            <!-- Right Content: History & Charts -->
            <div class="lg:col-span-8 xl:col-span-9 space-y-6">
                
                <!-- Charts Row -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="glass-panel p-4 rounded-3xl flex flex-col sm:flex-row items-center gap-6">
                        <div class="relative w-32 h-32 flex-shrink-0">
                            <canvas id="flavorChart"></canvas>
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <span class="text-[10px] text-gray-500 font-bold uppercase">Flavor Split</span>
                            </div>
                        </div>
                        <div class="flex-1 space-y-2 w-full">
                            <div class="flex justify-between items-center text-sm border-b border-white/5 pb-2">
                                <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500"></span> Chilli</span>
                                <span class="font-mono text-gray-300" id="chart-val-chilli">0</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Medium</span>
                                <span class="font-mono text-gray-300" id="chart-val-medium">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel p-4 rounded-3xl">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Top Customers</h3>
                        <div class="h-32 w-full relative">
                            <canvas id="topCustomersChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Main History Section -->
                <div class="glass-panel p-1 sm:p-6 rounded-3xl min-h-[500px]">
                    
                    <!-- Toolbar -->
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-4 px-2 pt-4">
                        <h3 class="text-xl font-bold text-white flex items-center gap-2">
                            <i class="ph ph-list-dashes text-amber-500"></i> Order History
                        </h3>
                        
                        <div class="flex flex-wrap items-center gap-2 w-full sm:w-auto">
                            <!-- Enhanced Search Bar -->
                            <div class="relative w-full sm:w-auto flex-grow sm:flex-grow-0">
                                <i class="ph ph-magnifying-glass absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm"></i>
                                <input id="searchInput" oninput="handleSearch(event)" type="text" placeholder="Search name, phone, flavor..." class="glass-input pl-9 pr-8 py-2 rounded-lg text-xs w-full sm:w-48 focus:w-64 transition-all">
                                <button id="clearSearchBtn" onclick="clearSearch()" class="hidden absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-white transition-colors">
                                    <i class="ph ph-x-circle text-lg"></i>
                                </button>
                            </div>
                            
                            <div class="flex bg-zinc-900/50 rounded-lg p-0.5 border border-white/5">
                                <button onclick="setFilter('all')" class="filter-btn px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-all bg-amber-500 text-black" data-filter="all">All</button>
                                <button onclick="setFilter('pending')" class="filter-btn px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-all text-gray-400 hover:text-white" data-filter="pending">Owe</button>
                                <button onclick="setFilter('paid')" class="filter-btn px-3 py-1.5 rounded-md text-[10px] font-bold uppercase transition-all text-gray-400 hover:text-white" data-filter="paid">Paid</button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Table / Cards -->
                    <div class="text-sm border-t border-white/5 mt-2">
                        <!-- Desktop Headers -->
                        <div class="desktop-table grid grid-cols-12 gap-4 px-4 py-2 text-xs font-bold text-gray-500 uppercase tracking-wider">
                            <div class="col-span-1"></div> <!-- Checkbox -->
                            <div class="col-span-2">Date</div>
                            <div class="col-span-5">Customer</div>
                            <div class="col-span-2 text-right">Amount</div>
                            <div class="col-span-2">Status</div>
                        </div>
                        
                        <!-- List Container -->
                        <div id="customerHistory" class="pb-20">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Action Bar (Bottom Fixed) -->
    <div id="bulkActionBar" class="fixed bottom-0 left-0 w-full bg-[#18181b] border-t border-white/10 p-4 transform translate-y-full transition-transform duration-300 z-50 shadow-2xl flex justify-between items-center">
        <span class="text-sm font-bold text-white"><span id="bulkCount">0</span> orders selected</span>
        <div class="flex gap-3">
            <button onclick="selectedOrderIds.clear(); renderBulkActions(); renderUI();" class="px-4 py-2 rounded-lg text-sm font-bold hover:bg-white/10 text-gray-400">Cancel</button>
            <button id="bulkActionBtn" onclick="bulkDelete()" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-500 text-white text-sm font-bold shadow-lg shadow-red-900/50">Delete Selected</button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="glass-panel w-full max-w-sm p-6 rounded-3xl border border-white/10 shadow-2xl animate-slide-up">
            <h3 class="text-lg font-bold text-white mb-4">Edit Order</h3>
            <div class="space-y-3">
                <input id="editCustomer" type="text" class="glass-input w-full px-4 py-3 rounded-xl text-sm">
                <div class="grid grid-cols-2 gap-3">
                    <select id="editFlavor" class="glass-input w-full px-4 py-3 rounded-xl text-sm"><option value="Chilli">Chilli</option><option value="Medium">Medium</option></select>
                    <input id="editQty" type="number" min="1" class="glass-input w-full px-4 py-3 rounded-xl text-sm">
                </div>
                <input id="editNotes" type="text" class="glass-input w-full px-4 py-3 rounded-xl text-sm">
                <div class="flex items-center gap-3">
                    <input id="editPaid" type="checkbox" class="w-5 h-5 accent-emerald-500 rounded">
                    <span class="text-sm font-bold text-gray-300">Mark as Paid</span>
                </div>
                
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button onclick="document.getElementById('editModal').classList.add('hidden')" class="bg-zinc-800 hover:bg-zinc-700 text-white font-bold py-3 rounded-xl transition-colors">Cancel</button>
                    <button onclick="saveEdit()" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-500/20">Save</button>
                </div>
            </div>
        </div>
    </div>

</body>
</html>